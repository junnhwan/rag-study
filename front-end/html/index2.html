<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能助手 - Spring AI Stream</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自定义滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* 保持换行格式 */
        .whitespace-pre-wrap {
            white-space: pre-wrap;
        }
        /* 打字机光标效果 */
        .typing-cursor::after {
            content: '▋';
            display: inline-block;
            animation: blink 1s infinite;
            margin-left: 2px;
            color: #3b82f6;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col md:flex-row overflow-hidden text-slate-800 font-sans">

<!-- 左侧侧边栏 -->
<aside class="w-full md:w-72 bg-white border-r border-gray-200 flex flex-col h-full shadow-sm z-10 transition-all duration-300">
    <!-- 头部：新建按钮 -->
    <div class="p-4 border-b border-gray-100">
        <button onclick="createNewChat()" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-xl transition-all shadow-md hover:shadow-lg transform active:scale-95 font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            新建聊天
        </button>
    </div>

    <!-- 聊天列表区域 -->
    <div id="chatListContainer" class="flex-1 overflow-y-auto p-3 space-y-2">
        <!-- 列表项将通过 JS 动态插入 -->
    </div>

    <!-- 底部信息 -->
    <div class="p-4 border-t border-gray-100 text-xs text-center text-gray-400">
        Based on Spring AI & DeepSeek
    </div>
</aside>

<!-- 右侧主聊天区域 -->
<main class="flex-1 flex flex-col h-full relative bg-gray-50">

    <!-- 顶部导航栏 -->
    <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-10">
        <div class="flex items-center gap-3">
            <div class="font-bold text-lg text-gray-800" id="currentChatTitle">新对话</div>
            <span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-700 font-medium">DeepSeek-R1</span>
        </div>
        <!-- 模型选择 (模拟) -->
        <select id="modelSelect" class="bg-gray-50 border border-gray-200 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 outline-none">
            <option value="deepseek-r1:1.5b" selected>deepseek-r1:1.5b</option>
            <option value="llama3">llama3</option>
        </select>
    </header>

    <!-- 消息展示区域 -->
    <div id="messagesArea" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth">
        <!-- 欢迎语 -->
        <div class="flex flex-col items-center justify-center h-full text-gray-400 space-y-4" id="emptyState">
            <div class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                </svg>
            </div>
            <p>开始一个新的对话吧</p>
        </div>
        <!-- 消息将通过 JS 插入 -->
    </div>

    <!-- 底部输入区域 -->
    <div class="p-4 md:p-6 bg-white border-t border-gray-200">
        <div class="max-w-4xl mx-auto relative group">
                <textarea
                        id="userInput"
                        rows="1"
                        placeholder="输入消息，Enter 发送，Shift + Enter 换行..."
                        class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-base rounded-2xl focus:ring-2 focus:ring-blue-500 focus:border-transparent block pl-4 pr-14 py-3.5 resize-none overflow-hidden transition-all shadow-sm outline-none"
                        oninput="autoResize(this)"
                        onkeydown="handleEnter(event)"
                ></textarea>

            <button
                    onclick="sendMessage()"
                    id="sendBtn"
                    class="absolute bottom-2 right-2 p-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-sm"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-90" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                </svg>
            </button>
        </div>
        <div class="text-center text-xs text-gray-400 mt-2">
            内容由 AI 生成，请注意甄别。
        </div>
    </div>
</main>

<script>
    // --- 数据状态管理 ---
    let chats = []; // 存储所有聊天会话
    let currentChatId = null; // 当前选中的会话ID
    let isGenerating = false; // 是否正在生成中

    // --- 初始化 ---
    document.addEventListener('DOMContentLoaded', () => {
        loadChats();
        if (chats.length === 0) {
            createNewChat();
        } else {
            selectChat(chats[0].id);
        }
    });

    // --- 会话管理逻辑 ---

    // 创建新聊天
    function createNewChat() {
        const newChat = {
            id: Date.now().toString(),
            title: '新对话',
            messages: []
        };
        chats.unshift(newChat); // 加到最前面
        saveChats();
        renderChatList();
        selectChat(newChat.id);

        // 移动端体验优化（可选）：如果是在移动端，这里可以收起侧边栏
    }

    // 选择聊天
    function selectChat(id) {
        currentChatId = id;
        const chat = chats.find(c => c.id === id);

        // 更新标题
        document.getElementById('currentChatTitle').textContent = chat ? chat.title : '新对话';

        // 渲染列表选中态
        renderChatList();

        // 渲染消息区
        renderMessages(chat ? chat.messages : []);
    }

    // 删除聊天
    function deleteChat(e, id) {
        e.stopPropagation(); // 阻止冒泡触发选择
        if(!confirm('确定要删除这条对话吗？')) return;

        chats = chats.filter(c => c.id !== id);
        saveChats();

        // 如果删除的是当前选中的
        if (id === currentChatId) {
            if (chats.length > 0) {
                selectChat(chats[0].id);
            } else {
                createNewChat();
            }
        } else {
            renderChatList();
        }
    }

    // 重命名聊天
    function renameChat(e, id) {
        e.stopPropagation();
        const chat = chats.find(c => c.id === id);
        const newName = prompt("请输入新的对话名称", chat.title);
        if (newName && newName.trim() !== "") {
            chat.title = newName.trim();
            saveChats();
            renderChatList();
            if (currentChatId === id) {
                document.getElementById('currentChatTitle').textContent = chat.title;
            }
        }
    }

    // --- 渲染逻辑 ---

    // 渲染左侧列表
    function renderChatList() {
        const container = document.getElementById('chatListContainer');
        container.innerHTML = '';

        chats.forEach(chat => {
            const isActive = chat.id === currentChatId;
            const div = document.createElement('div');
            // Tailwind 样式类
            div.className = `group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all duration-200 border border-transparent ${
                isActive
                    ? 'bg-blue-50 border-blue-100 shadow-sm'
                    : 'hover:bg-gray-100'
            }`;
            div.onclick = () => selectChat(chat.id);

            div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="${isActive ? 'text-blue-600' : 'text-gray-400'}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                            </svg>
                        </div>
                        <span class="text-sm font-medium truncate ${isActive ? 'text-blue-900' : 'text-gray-700'} max-w-[120px]">
                            ${chat.title}
                        </span>
                    </div>

                    <!-- 操作按钮 (悬停显示) -->
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${isActive ? 'opacity-100' : ''}">
                        <button onclick="renameChat(event, '${chat.id}')" class="p-1 hover:bg-gray-200 rounded text-gray-500 hover:text-blue-600 transition-colors" title="重命名">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <button onclick="deleteChat(event, '${chat.id}')" class="p-1 hover:bg-red-100 rounded text-gray-500 hover:text-red-600 transition-colors" title="删除">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
            container.appendChild(div);
        });
    }

    // 渲染消息流
    function renderMessages(messages) {
        const container = document.getElementById('messagesArea');
        const emptyState = document.getElementById('emptyState');

        container.innerHTML = ''; // 清空

        if (messages.length === 0) {
            container.appendChild(emptyState);
            emptyState.style.display = 'flex';
            return;
        }
        emptyState.style.display = 'none';

        messages.forEach(msg => {
            appendMessageToDom(msg.role, msg.content, false);
        });

        scrollToBottom();
    }

    // --- 发送与API交互逻辑 ---

    // 处理回车键
    function handleEnter(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // 阻止默认换行
            sendMessage();
        }
    }

    // 文本框自适应高度
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
        if(textarea.value === '') textarea.style.height = 'auto';
    }

    async function sendMessage() {
        if (isGenerating) return;

        const input = document.getElementById('userInput');
        const message = input.value.trim();
        const model = document.getElementById('modelSelect').value;

        if (!message) return;

        // 1. UI 状态更新
        input.value = '';
        input.style.height = 'auto';
        isGenerating = true;
        document.getElementById('sendBtn').disabled = true;

        // 2. 将用户消息加入数据并渲染
        addMessageToChat(currentChatId, 'USER', message);
        appendMessageToDom('USER', message);

        // 3. 准备接收 AI 消息
        // 创建一个临时的 AI 消息 DOM，用于流式更新
        const aiContentDiv = appendMessageToDom('ASSISTANT', '', true); // true 表示正在加载/流式
        let fullAiResponse = "";

        try {
            // 4. 调用服务端 SSE 接口
            // 接口: http://localhost:8090/api/v1/ollama/generate_stream?model=xxx&message=xxx
            const url = `http://localhost:8090/api/v1/ollama/generate_stream?model=${encodeURIComponent(model)}&message=${encodeURIComponent(message)}`;

            const eventSource = new EventSource(url);

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    // 从 result.output.content 获取文本
                    const content = data.result?.output?.content;

                    if (content) {
                        fullAiResponse += content;
                        aiContentDiv.textContent = fullAiResponse;
                        scrollToBottom();
                    }

                    // 从 result.metadata.finishReason 获取结束标识
                    if (data.result?.metadata?.finishReason === "STOP") {
                        eventSource.close();
                        finishGeneration(fullAiResponse);
                    }

                } catch (e) {
                    console.error("解析响应失败", e);
                }
            };

            eventSource.onerror = (err) => {
                console.error("EventSource 错误", err);
                eventSource.close();
                finishGeneration(fullAiResponse); //即使出错也保存已接收的内容
            };

        } catch (error) {
            console.error("请求失败", error);
            aiContentDiv.textContent = "Error: 无法连接到服务。";
            finishGeneration("Error: 无法连接到服务。");
        }
    }

    // 结束生成后的清理工作
    function finishGeneration(finalText) {
        isGenerating = false;
        document.getElementById('sendBtn').disabled = false;

        // 移除光标效果
        const loadingCursors = document.querySelectorAll('.typing-cursor');
        loadingCursors.forEach(el => el.classList.remove('typing-cursor'));

        // 保存 AI 回复到历史记录
        addMessageToChat(currentChatId, 'ASSISTANT', finalText);
    }

    // --- DOM 操作辅助 ---

    function appendMessageToDom(role, content, isStreaming = false) {
        const container = document.getElementById('messagesArea');
        const emptyState = document.getElementById('emptyState');
        emptyState.style.display = 'none';

        const isUser = role === 'USER';

        const wrapper = document.createElement('div');
        wrapper.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'}`;

        const avatarHtml = isUser
            ? `<div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white flex-shrink-0 ml-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>`
            : `<div class="w-8 h-8 rounded-full bg-orange-500 flex items-center justify-center text-white flex-shrink-0 mr-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>`;

        // 消息气泡样式
        const bubbleClass = isUser
            ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none shadow-md'
            : 'bg-white border border-gray-100 text-gray-800 rounded-2xl rounded-tl-none shadow-sm';

        // 流式响应时的光标动画类
        const cursorClass = (isStreaming && !isUser) ? 'typing-cursor' : '';

        wrapper.innerHTML = `
                ${!isUser ? avatarHtml : ''}
                <div class="max-w-[85%] md:max-w-[70%] p-3.5 px-5 text-base leading-relaxed whitespace-pre-wrap ${bubbleClass} ${cursorClass}">
                    ${content}
                </div>
                ${isUser ? avatarHtml : ''}
            `;

        container.appendChild(wrapper);
        scrollToBottom();

        // 如果是流式，返回内容 div 的引用以便更新
        if(isStreaming) {
            return wrapper.querySelector('.whitespace-pre-wrap');
        }
    }

    function scrollToBottom() {
        const container = document.getElementById('messagesArea');
        container.scrollTop = container.scrollHeight;
    }

    // --- 数据存储 (简单Localstorage模拟) ---
    function addMessageToChat(chatId, role, content) {
        const chat = chats.find(c => c.id === chatId);
        if (chat) {
            chat.messages.push({ role, content });
            // 更新标题（如果是第一条消息）
            if (chat.messages.length === 2 && chat.title === '新对话') {
                // 使用用户的第一条消息的前10个字作为标题
                chat.title = chat.messages[0].content.substring(0, 10) + (chat.messages[0].content.length > 10 ? '...' : '');
                renderChatList();
                document.getElementById('currentChatTitle').textContent = chat.title;
            }
            saveChats();
        }
    }

    function saveChats() {
        // 这里可以对接后端保存，目前仅用内存/本地存储演示
        localStorage.setItem('ai_chats', JSON.stringify(chats));
    }

    function loadChats() {
        const saved = localStorage.getItem('ai_chats');
        if (saved) {
            chats = JSON.parse(saved);
        }
    }
</script>
</body>
</html>